@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutUser.cshtml";
}
@model PagedList<Poco.AutoMessage_Keyword>
@section head{
    <style>
        .keyItem:first-child
        {
            margin-top: 0px !important;
        }
        .keyItem
        {
            width: 100%;
            background-color: White;
            margin-top: 10px;
            border: 1px solid #d3d3d3;
        }
        .keyTitle
        {
            height: 30px;
            background-color: #F0F0F0;
            line-height: 30px;
            padding: 0px 5px;
            border-bottom: 1px solid #d3d3d3;
        }
        .keyword
        {
            margin: 10px 5px 5px 5px;
            height: 20px;
            max-height: 60px;
        }
        .keyMessage
        {
            margin: 5px 5px 10px 5px;
            max-height: 60px;
            line-height: 20px;
        }
        #div_addKeyrule
        {
            width: 100%;
            min-height: 430px;
            background-color: White;
            border: 1px solid #d3d3d3;
            display: none;
        }
        .keyRight
        {
            border: 1px solid #d3d3d3;
            border-radius: 3px;
            -moz-border-radius: 3px;
            -webkit-border-radius: 3px;
            min-height: 250px;
        }
        .keyMessageItem
        {
            border-bottom: 1px solid #d3d3d3;
            height: 30px;
            line-height: 30px;
            padding: 0px 5px 0px 5px;
        }
        .newAddBtn
        {
            cursor: pointer;
        }
    </style>
    <script type="text/javascript">
        var addUrl = '@Url.Action("Add", "KeywordMessage")';
        var editUrl = '@Url.Action("Edit", "KeywordMessage")';
        var getRuleNoUrl = '@Url.Action("GetRuleNoString", "KeywordMessage")';
        var getEntityUrl = '@Url.Action("Get", "KeywordMessage")';
        $(function () {
            $("#btnAddRule").click(function () {
                if ($("#div_addKeyrule:hidden").length == 0) {
                    $("#div_addKeyrule").slideToggle(1, function () {
                        clearText();
                    });
                }
                $("#div_addKeyrule").slideToggle(1, function () {
                    if ($("#div_addKeyrule:hidden").length == 0) {
                        $.ajax({
                            type: "get",
                            data: { fullRuleNo: null },
                            url: getRuleNoUrl,
                            success: function (result) {
                                if (result != undefined && result != null && result.length > 0) {
                                    $("#txtRuleNo").val(result);
                                    $("#hidRuleNo").val(result);
                                }
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                JAlert({
                                    Message: "Internal Server Error.",
                                    DialogType: "Ok",
                                    BtnOk: "确定"
                                });
                            }
                        });
                    } else {
                        clearText();
                    }
                });
            });

            $(".btnAddSub").click(function () {
                if ($("#div_addKeyrule:hidden").length == 0) {
                    $("#div_addKeyrule").slideToggle(1, function () {
                        clearText();
                    });
                }
                var fullRuleNo = $(this).attr("fullRuleNo");
                var ruleNo = $(this).attr("ruleNo");
                var parentID = $(this).attr("parentID");
                $("#hidRuleNo").val(ruleNo);
                $("#hidParentID").val(parentID);
                $("#div_addKeyrule").slideToggle(1, function () {
                    if ($("#div_addKeyrule:hidden").length == 0) {
                        $.ajax({
                            type: "get",
                            data: { fullRuleNo: fullRuleNo },
                            url: getRuleNoUrl,
                            success: function (result) {
                                if (result != undefined && result != null && result.length > 0) {
                                    $("#txtRuleNo").val(result);
                                }
                            },
                            error: function (XMLHttpRequest, textStatus, errorThrown) {
                                JAlert({
                                    Message: "Internal Server Error.",
                                    DialogType: "Ok",
                                    BtnOk: "确定"
                                });
                            }
                        });
                    } else {
                        clearText();
                    }
                });
            });

            $(".btnEdit").click(function () {
                if ($("#div_addKeyrule:hidden").length == 0) {
                    $("#labTitlt").text("新规则");
                    $("#div_addKeyrule").slideToggle(1, function () {
                        clearText();
                    });
                } else {
                    $("#labTitlt").text("修改规则");
                    var keyId = $(this).attr("keyID");
                    $.get(getEntityUrl, { id: keyId }, function (result) {
                        $("#div_addKeyrule").slideToggle(1, function () {
                            if ($("#div_addKeyrule:hidden").length == 0) {
                                $("#txtRuleName").val(result.RuleName);
                                $("#txtRuleNo").val(result.FullRuleNo);
                                $("#txtKey").val(result.Keywords);
                                $("#hidKeyID").val(keyId);

                                var content = "";
                                var textReplysJSON = JSON.parse(result.TextReplys).TextReplys;
                                $.each(textReplysJSON, function (i, n) {
                                    content += '<div class="keyMessageItem"><label class="msgText">' + n + '</label><span style="float: right;cursor: pointer;" onclick="delText(this)">删除</span></div>';
                                });
                                $("#msgContent").append(content);
                            } else {
                                clearText();
                            }
                        });
                    }, "json")
                }
            });

            $("#btnCancel").click(function () {
                clearText();
                $("#div_addKeyrule").slideToggle(1, function () { });
            });


            $("#btnSaveRule").click(function () {
                SaveOrEdit();
            });

            $("#btnAddText").click(function () {
                $("#dialogText").dialog({
                    resizable: false,
                    height: 219,
                    width: 579,
                    modal: true,
                    draggable: false,
                    buttons: {
                        "确定": function () {
                            var txtMsgText = $("#txtMsgText").val().trim();
                            if (txtMsgText.length == 0) {
                                JAlert({
                                    Message: "内容不能为空。",
                                    DialogType: "Ok",
                                    BtnOk: "确定"
                                });
                            } else {
                                $("#msgContent").append('<div class="keyMessageItem"><label class="msgText">' + txtMsgText + '</label><span style="float: right;cursor: pointer;" onclick="delText(this)">删除</span></div>');
                                $("#txtMsgText").val("");
                                $(this).dialog("close");
                            }

                        },
                        "取消": function () {
                            $(this).dialog("close");
                        }
                    }
                });
            });
        });
        function delText(obj) {
            $(obj).parent().remove();
        }
        function clearText() {
            $("#labTitlt").text("新规则");
            $("#txtRuleNo").val("");
            $("#hidRuleNo").val("");
            $("#hidParentID").val("");
            $("#hidKeyID").val("");

            $("#txtRuleName").val("");
            $("#txtRuleNo").val("");
            $("#txtKey").val("");
            $("#msgContent").empty();
        }
        function SaveOrEdit() {
            var ruleName = $("#txtRuleName").val().trim();
            var hidRuleNo = $("#hidRuleNo").val().trim();
            var fullRuleNo = $("#txtRuleNo").val().trim();
            var parentID = $("#hidParentID").val().trim();
            if (parentID.length == 0) {
                parentID = null;
            }
            if (ruleName.length == 0) {
                $("#txtRuleName").focus();
                JAlert({
                    Message: "请输入规则名称。",
                    DialogType: "Ok",
                    BtnOk: "确定"
                });
                return false;
            }
            var key = $("#txtKey").val().trim();
            if (key.length == 0) {
                $("#txtKey").focus();
                JAlert({
                    Message: "请输入关键字。",
                    DialogType: "Ok",
                    BtnOk: "确定"
                });
                return false;
            }
            var messageCount = $(".keyMessageItem").length;
            if (messageCount <= 1) {
                JAlert({
                    Message: "请添加回复消息。",
                    DialogType: "Ok",
                    BtnOk: "确定"
                });
                return false;
            }
            var msgTexts = "";
            $.each($(".msgText"), function (i, n) {
                msgTexts += $(n).text() + "|";
            });
            var keyId = $("#hidKeyID").val().trim();
            if (keyId.length>0) {
                $.ajax({
                    type: "post",
                    data: { keyID: keyId, ruleName: ruleName, keys: key, messageTexts: msgTexts, messageFileIDs: null, messageImageTextIDs: null },
                    url: editUrl,
                    success: function (result) {
                        if (result != undefined && result != null && result.length > 0) {
                            eval(result);
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        JAlert({
                            Message: "Internal Server Error.",
                            DialogType: "Ok",
                            BtnOk: "确定"
                        });
                    }
                });
            } else {
                $.ajax({
                    type: "post",
                    data: { ruleName: ruleName, ruleNo: hidRuleNo, fullRuleNo: fullRuleNo, parentID: parentID, keys: key, messageTexts: msgTexts, messageFileIDs: null, messageImageTextIDs: null },
                    url: addUrl,
                    success: function (result) {
                        if (result != undefined && result != null && result.length > 0) {
                            eval(result);
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        JAlert({
                            Message: "Internal Server Error.",
                            DialogType: "Ok",
                            BtnOk: "确定"
                        });
                    }
                });
            }
        }
    </script>
}
<div class="title">
    设置</div>
<div class="bodyLeft">
    <ul class="ulList">
        <li><a href="@Url.Action("Index", "InstallAppReply", new { HostName = ViewBag.HostName })">
            安装App自动回复</a></li>
        <li class="select"><a href="@Url.Action("Index", "KeywordMessage", new { HostName = ViewBag.HostName })">
            关键词自动回复</a></li>
    </ul>
</div>
<div class="bodyRight" style="height: auto;">
    <div class="option">
        <input id="btnAddRule" value="添加规则" type="button" />
    </div>
    <div id="div_addKeyrule">
        <div class="keyTitle">
            <label id="labTitlt">
                新规则</label>
        </div>
        <div style="padding: 10px 5px 0px 10px;">
            规则名：<input id="txtRuleName" type="text" />&nbsp;(规则名最多30个字)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;规则编号：<input
                type="text" id="txtRuleNo" readonly="readonly" /><input type="hidden" id="hidRuleNo" /><input
                    type="hidden" id="hidParentID" /><input type="hidden" id="hidKeyID" />
            <div>
                <span style="vertical-align: top">关键字：</span><textarea id="txtKey" rows="3" cols="87"></textarea>
            </div>
        </div>
        <div style="padding: 5px 5px 0px 10px;">
            <div class="keyRight">
                <div class="keyTitle">
                    回复<div style="float: right">
                        文字(0)&nbsp;&nbsp;文件(0)&nbsp;&nbsp;图文(0)</div>
                </div>
                <div id="msgContent">
                </div>
                <div class="keyMessageItem" style="margin-bottom: 60px;">
                    新增回复&nbsp;>&nbsp;&nbsp;<span class="newAddBtn" id="btnAddText">文字</span>&nbsp;&nbsp;<span
                        class="newAddBtn">文件</span>&nbsp;&nbsp;<span class="newAddBtn">图文</span></div>
            </div>
        </div>
        <div style="padding: 10px 5px 10px 10px; float: right; width: 180px">
            <input class="button" value="保存" type="button" id="btnSaveRule" />&nbsp;&nbsp;<input
                class="button" type="button" value="取消" id="btnCancel" />
        </div>
        <div style="clear: both">
        </div>
    </div>
    <div style="margin: 10px auto 15px auto;">
        @foreach (var item in Model)
        {
            <div class="keyItem">
                <div class="keyTitle">
                    规&nbsp;&nbsp;&nbsp;则：@item.RuleName [@item.FullRuleNo]
                    <div style="float: right">
                        <a>查看子项</a>&nbsp;&nbsp;<a class="btnAddSub" fullRuleNo="@item.FullRuleNo" ruleNo="@item.RuleNo" parentID="@item.ID">
                            添加子项</a>&nbsp;&nbsp;<a class="btnEdit" keyID="@item.ID" fullRuleNo="@item.FullRuleNo" ruleNo="@item.RuleNo" parentID="@item.ID">修改</a>&nbsp;&nbsp;<a>删除</a>
                    </div>
                </div>
                <div class="keyContent">
                    <div class="keyword">
                        关键词：@item.Keywords.Select(a => a.Token).ToList().ConvertToString(",")
                    </div>
                    <div class="keyMessage">
                        <div style="width: 63px; float: left; margin-left: 1px">
                            回&nbsp;&nbsp;&nbsp;复：</div>
                        <div style="width: 620px; float: left">
                            @foreach (var textItem in item.TextReplys)
                            {
                                <div>
                                    @textItem.Content.Show(30, "...")
                                </div>
                            }
                        </div>
                        <div style="clear: both">
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
    <div class="pages">
        @Html.Pager(Model, new PagerOptions
   {
       PageIndexParameterName = "ID",
       CurrentPagerItemWrapperFormatString = "<span class=\"pagenum_selected\"><a>{0}</a></span>",
       NumericPagerItemWrapperFormatString = "<span class=\"pagenum\">{0}</span>",
       NavigationPagerItemWrapperFormatString = "<span class=\"pagenum\">{0}</span>",
       CssClass = "manage_pages pages",
       SeparatorHtml = "&nbsp;",
       AutoHide = false,
       /*LastPageText = "Last",
       FirstPageText = "First",
       PrevPageText = "Back",
       NextPageText = "Next",*/
       PageIndexOutOfRangeErrorMessage = "Page index out of range.",
       ShowFirstLast = false
   })
    </div>
</div>
<div style="clear: both">
</div>
<div id="dialogText" title="添加回复文字" style="display: none">
    <textarea cols="75" rows="6" id="txtMsgText"></textarea>
</div>
