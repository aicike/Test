@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutUser.cshtml";
}
@model PagedList<Poco.AutoMessage_Keyword>
@section head{
    <style>
        .keyItem:first-child
        {
            margin-top: 0px !important;
        }
        .keyItem
        {
            width: 100%;
            height: 150px;
            background-color: White;
            margin-top: 10px;
            border: 1px solid #d3d3d3;
        }
        .keyTitle
        {
            height: 30px;
            background-color: #F0F0F0;
            line-height: 30px;
            padding: 0px 5px;
            border-bottom: 1px solid #d3d3d3;
        }
        .keyword
        {
            margin: 10px 5px 5px 5px;
            height: 45px;
            max-height: 60px;
        }
        .keyMessage
        {
            margin: 5px 5px 10px 5px;
            height: 40px;
            max-height: 60px;
        }
        #div_addKeyrule
        {
            width: 100%;
            min-height: 430px;
            background-color: White;
            border: 1px solid #d3d3d3;
        }
        .keyRight
        {
            border: 1px solid #d3d3d3;
            border-radius: 3px;
            -moz-border-radius: 3px;
            -webkit-border-radius: 3px;
            min-height: 250px;
        }
        .keyMessageItem
        {
            border-bottom: 1px solid #d3d3d3;
            height: 30px;
            line-height: 30px;
            padding: 0px 5px 0px 5px;
        }
        .newAddBtn
        {
            cursor: pointer;
        }
    </style>
    <script type="text/javascript">
        $(function () {
            var addUrl = '@Url.Action("Add", "KeywordMessage")';
            $("#btnSaveRule").click(function () {
                var ruleName = $("#txtRuleName").val().trim();
                if (ruleName.length == 0) {
                    $("#txtRuleName").focus();
                    JAlert({
                        Message: "请输入规则名称。",
                        DialogType: "Ok",
                        BtnOk: "确定"
                    });
                    return false;
                }
                var key = $("#txtKey").val().trim();
                if (key.length == 0) {
                    $("#txtKey").focus();
                    JAlert({
                        Message: "请输入关键字。",
                        DialogType: "Ok",
                        BtnOk: "确定"
                    });
                    return false;
                }
                var messageCount = $(".keyMessageItem").length;
                if (messageCount <= 1) {
                    JAlert({
                        Message: "请添加回复消息。",
                        DialogType: "Ok",
                        BtnOk: "确定"
                    });
                    return false;
                }
                var msgTexts = null;
                $.each($(".msgText"), function (i, n) {
                    msgTexts += $(n).text() + "|";
                });

                $.ajax({
                    type: "post",
                    data: { ruleName: ruleName, keys: key, messageTexts: msgTexts, messageFileIDs: null, messageImageTextIDs: null },
                    url: addUrl,
                    success: function (result) {
                        if (result != undefined && result != null && result.length > 0) {
                            eval(result);
                        }
                    },
                    error: function (XMLHttpRequest, textStatus, errorThrown) {
                        JAlert({
                            Message: "Internal Server Error.",
                            DialogType: "Ok",
                            BtnOk: "确定"
                        });
                    }
                });
            });

            $("#btnAddText").click(function () {
                $("#dialogText").dialog({
                    resizable: false,
                    height: 219,
                    width: 579,
                    modal: true,
                    draggable: false,
                    buttons: {
                        "确定": function () {
                            var txtMsgText = $("#txtMsgText").val().trim();
                            if (txtMsgText.length == 0) {
                                JAlert({
                                    Message: "内容不能为空。",
                                    DialogType: "Ok",
                                    BtnOk: "确定"
                                });
                            } else {
                                $("#msgContent").append('<div class="keyMessageItem"><label class="msgText">' + txtMsgText + '</label><span style="float: right;cursor: pointer;" onclick="delText(this)">删除</span></div>');
                                $("#txtMsgText").val("");
                                $(this).dialog("close");
                            }

                        },
                        "取消": function () {
                            $(this).dialog("close");
                        }
                    }
                });
            });
        });
        function delText(obj) {
            $(obj).parent().remove();
        }
    </script>
}
<div class="title">
    设置</div>
<div class="bodyLeft">
    <ul class="ulList">
        <li><a href="@Url.Action("Index", "InstallAppReply", new { HostName = ViewBag.HostName })">
            安装App自动回复</a></li>
        <li class="select"><a href="@Url.Action("Index", "KeywordMessage", new { HostName = ViewBag.HostName })">
            关键词自动回复</a></li>
    </ul>
</div>
<div class="bodyRight" style="height: auto;">
    <div class="option">
        <input id="btnAddRule" value="添加规则" type="button" />
    </div>
    <div id="div_addKeyrule">
        <div class="keyTitle">
            新规则
        </div>
        <div style="padding: 10px 5px 0px 10px;">
            规则名：<input id="txtRuleName" type="text" />&nbsp;(规则名最多30个字)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;规则编号：<input
                type="text" />
            <div>
                <span style="vertical-align: top">关键字：</span><textarea id="txtKey" rows="3" cols="87"></textarea>
            </div>
        </div>
        <div style="padding: 5px 5px 0px 10px;">
            <div class="keyRight">
                <div class="keyTitle">
                    回复<div style="float: right">
                        文字(0)&nbsp;&nbsp;文件(0)&nbsp;&nbsp;图文(0)</div>
                </div>
                <div id="msgContent">
                    @*<div class="keyMessageItem">
                         <label class="msgText">阿斯顿法师打发斯蒂芬</label><span style="float: right">删除</span></div>
                    <div class="keyMessageItem">
                        asdf<span style="float: right">删除</span></div>*@
                </div>
                <div class="keyMessageItem" style="margin-bottom: 60px;">
                    新增回复&nbsp;>&nbsp;&nbsp;<span class="newAddBtn" id="btnAddText">文字</span>&nbsp;&nbsp;<span
                        class="newAddBtn">文件</span>&nbsp;&nbsp;<span class="newAddBtn">图文</span></div>
            </div>
        </div>
        <div style="padding: 10px 5px 10px 10px; float: right; width: 180px">
            <input class="button" value="保存" type="button" id="btnSaveRule" />&nbsp;&nbsp;<input
                class="button" type="button" value="删除" id="btnDeleteRule" />
        </div>
        <div style="clear: both">
        </div>
    </div>
    <div style="margin: 10px auto 15px auto;">
        @foreach (var item in Model)
        {
            <div class="keyItem">
                <div class="keyTitle">
                    规&nbsp;&nbsp;&nbsp;则：@item.RuleName
                </div>
                <div class="keyContent">
                    <div class="keyword">
                        关键词：@item.Keywords.Select(a => a.Token).ToList().ConvertToString(",")
                    </div>
                    <div class="keyMessage">
                        回&nbsp;&nbsp;&nbsp;复：
                        <div>
                            @foreach (var textItem in item.TextReplys)
                            {
                                <div>
                                    @textItem.Content.Show(30, "...");
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
    <div class="pages">
        @Html.Pager(Model, new PagerOptions
   {
       PageIndexParameterName = "ID",
       CurrentPagerItemWrapperFormatString = "<span class=\"pagenum_selected\"><a>{0}</a></span>",
       NumericPagerItemWrapperFormatString = "<span class=\"pagenum\">{0}</span>",
       NavigationPagerItemWrapperFormatString = "<span class=\"pagenum\">{0}</span>",
       CssClass = "manage_pages pages",
       SeparatorHtml = "&nbsp;",
       AutoHide = false,
       /*LastPageText = "Last",
       FirstPageText = "First",
       PrevPageText = "Back",
       NextPageText = "Next",*/
       PageIndexOutOfRangeErrorMessage = "Page index out of range.",
       ShowFirstLast = false
   })
    </div>
</div>
<div style="clear: both">
</div>
<div id="dialogText" title="添加回复文字" style="display: none">
    <textarea cols="75" rows="6" id="txtMsgText"></textarea>
</div>
