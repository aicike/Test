@{
    Layout = "~/Views/Shared/_LayoutUser.cshtml";
    ViewBag.Menu = Poco.SystemConst.Menu.Set;
    string editStatus = ViewBag.EditStatus;
    string error = ViewBag.EditError;
    var isEdit = false;
    if (editStatus != null)
    {
        isEdit = true;
    }
}
@model Poco.Account
@section head{
    <script src="@Url.Content("~/Scripts/Jcrop/jquery.Jcrop.js")" type="text/javascript"></script>
    <link href="@Url.Content("~/Scripts/Jcrop/jquery.Jcrop.css")" rel="stylesheet" type="text/css" />
    <script>

        var Cnt = 0;
        $(function () {
//            $("#btnUpload").click(function () {
//                $("#HeadImagePathFile").click();
//            });

                var jcrop_api, boundx, boundy;

               


              function updatePreview(c)
              {
                    if (parseInt(c.w) > 0)
                    {
                      var rx = 120 / c.w;
                      var ry = 120 / c.h;

                      $('#imgLogo').css({
                        width: Math.round(rx * boundx) + 'px',
                        height: Math.round(ry * boundy) + 'px',
                        marginLeft: '-' + Math.round(rx * c.x) + 'px',
                        marginTop: '-' + Math.round(ry * c.y) + 'px'
                      });
                    }
                    $('#x1').val(c.x);
                    $('#y1').val(c.y);
                    $('#w').val(c.w);
                    $('#h').val(c.h);
              };







            $("#LoginPwdPage,#LoginPwdPageCompare").val('@Common.DESEncrypt.Decrypt(Model.LoginPwd)');

            //选择本地图片
            $("#HeadImagePathFile").change(function () {

               
                var fileName = $("#HeadImagePathFile").val();
                //$("#HeadImagePath").val(fileName);
                var suffix = fileName.substring(fileName.lastIndexOf('.')).toLowerCase();
                $("span[data-valmsg-for='HeadImagePath']").empty().attr("class", "field-validation-valid");
                var isOk = false;
                switch (suffix) {
                    case ".jpg":
                    case ".jpeg":
                    case ".png":
                    case ".gif":
                    case ".bmp":
                        isOk = true;
                        break;
                    default:
                        $("#HeadImagePathFile").val("");
                        $("span[data-valmsg-for='HeadImagePath']").text("支持下列图片格式：.jpg|.jpeg|.png|.gif|.bmp").attr("class", "field-validation-error");
                        break;
                } if (isOk) {
                    var input = this;
                    if (input.files && input.files[0]) {
                        var reader = new FileReader();
                        reader.onload = function (e) {

                            if(Cnt>0)
                            {
                               jcrop_api.destroy();
                            }
                            $("#imgSel").attr('src',e.target.result);
                            $("#imgLogo").attr('src', e.target.result);
                            

                            
                            $('#imgSel').Jcrop({
                                onChange:   updatePreview,
                                onSelect:   updatePreview,
                                aspectRatio: 1
                              },function(){
                                // Use the API to get the real image size
                                var bounds = this.getBounds();
                                boundx = bounds[0];
                                boundy = bounds[1];
                                // Store the API in the jcrop_api variable
                                jcrop_api = this;
                              });
                              Cnt = 1;
                              

                        };
                        reader.readAsDataURL(input.files[0]);
                    }
                    else {
                        $("#imgLogo").attr('src', "#");
                        $("#HeadImagePath").val("");
                    }
                }

                return false;
            });

            @if (isEdit)
            {
                if (editStatus == "true")
                { 
                     @:JAlert({Message: "修改成功。",DialogType: "Ok",BtnOk: "确定"});
                }
                else
                { 
                     @:JAlert({Message: "@error",DialogType: "Ok",BtnOk: "确定"});
                }
            }
        });
    </script>
    <style type="text/css">
        .middle-out
        {
            width: 320px;
            height: 320px;
            display: table-cell;
            vertical-align: middle;
            text-align: center;
            border: 1px solid #f00;
        }
        /* .middle-out .middle-in {position:static;*position:relative;top:-50%;left:-50%;}*/
    </style>
}
<div class="title">
    设置</div>
<div class="bodyLeft">
    <ul class="ulList">
        <li class="select">@Html.ActionLink("个人信息", "Index", "Set", new { HostName = ViewBag.HostName }, null, true)</li>
        <li>@Html.ActionLink("基础设置", "Index", "BasisSet", new { HostName = ViewBag.HostName }, null, true)</li>
        <li>@Html.ActionLink("安装App自动回复", "Index", "InstallAppReply", new { HostName = ViewBag.HostName }, null, true)</li>
        <li>@Html.ActionLink("关键词自动回复", "Index", "KeywordMessage", new { HostName = ViewBag.HostName }, null, true)</li>
    </ul>
</div>
<div class="bodyRight">
    @using (Html.BeginForm("Edit", "Set", new { HostName = ViewBag.HostName }, FormMethod.Post, new { enctype = "multipart/form-data" }))
    {
        <fieldset style="border: 1px solid #E7E7E7;">
            <legend>头像</legend>
            <table>
                <tr>
                    <td>
                        <div class="middle-out">
                            <div class="middle-in" style="margin: auto 0px">
                                <img id="imgSel"  src="@Url.Content("~/Images/SelImg.jpg")"   style="max-height:320px; max-width:320px;" />
                            </div>
                        </div>
                    </td>
                    <td>
                        <div style="width: 120px; height: 120px; overflow: hidden;">
                            <img id="imgLogo" src="@Url.Content(Model.HeadImagePath)" style="width:120px; height:120px"/>
                        </div>
                        @Html.TextBoxFor(a => a.HeadImagePath, new { style = "width:0px;visibility:hidden" })
                        @Html.ValidationMessageFor(a => a.HeadImagePath)
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <input type="file" id="HeadImagePathFile" name="HeadImagePathFile" />
                        <div>
                            <label>
                                X1
                                <input type="text" size="4" id="x1" name="x1" /></label>
                            <label>
                                Y1
                                <input type="text" size="4" id="y1" name="y1" /></label>
                            <label>
                                W
                                <input type="text" size="4" id="w" name="w" /></label>
                            <label>
                                H
                                <input type="text" size="4" id="h" name="h" /></label>
                        </div>
                    </td>
                </tr>
            </table>
        </fieldset>
        
        <fieldset style="border: 1px solid #E7E7E7;">
            <legend>账号信息</legend>
            <table>
                <tr>
                    <td class="tdTitle">
                        名称
                    </td>
                    <td class="tdField">@Html.TextBoxFor(a => a.Name)@Html.HiddenFor(a => a.ID)@Html.HiddenFor(a => a.AccountStatusID)@Html.HiddenFor(a => a.IsActivated)@Html.HiddenFor(a => a.RoleID)
                    </td>
                    <td>@Html.ValidationMessageFor(a => a.Name)
                    </td>
                </tr>
                <tr>
                    <td>
                        邮箱
                    </td>
                    <td>@Html.TextBoxFor(a => a.Email, new { val = Model.ID })
                    </td>
                    <td>@Html.ValidationMessageFor(a => a.Email)
                    </td>
                </tr>
                <tr>
                    <td>
                        密码
                    </td>
                    <td>@Html.PasswordFor(a => a.LoginPwdPage)
                    </td>
                    <td>@Html.ValidationMessageFor(a => a.LoginPwdPage)
                    </td>
                </tr>
                <tr>
                    <td>
                        确认密码
                    </td>
                    <td>@Html.PasswordFor(a => a.LoginPwdPageCompare)
                    </td>
                    <td>@Html.ValidationMessageFor(a => a.LoginPwdPageCompare)
                    </td>
                </tr>
                <tr>
                    <td>
                        电话
                    </td>
                    <td>@Html.TextBoxFor(a => a.Phone)
                    </td>
                    <td>@Html.ValidationMessageFor(a => a.Phone)
                    </td>
                </tr>
            </table>
        </fieldset>
        <div class="action">
            <input type="submit" id="btnSubmit" value="保存" class="button" />
        </div>
    }
</div>
<div style="clear: both">
</div>
