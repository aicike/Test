@{
    ViewBag.Title = "Image";
    Layout = "~/Views/Shared/_LayoutUser.cshtml";
    var libraryType = ViewBag.LibraryType as List<Poco.LibraryType>;
    ViewBag.Menu = Poco.SystemConst.Menu.LibraryImage;
}
@section head{
    <link href="@Url.Content("~/Scripts/uploadify/uploadify.css")" rel="stylesheet" type="text/css" />
    <script src="@Url.Content("~/Scripts/uploadify/jquery.uploadify.js")" type="text/javascript"></script>
    <script type="text/javascript">
        var uploadUrl = '@Url.Action("Upload", "LibraryImage", new { HostName = ViewBag.HostName })';
        var renameUrl = '@Url.Action("ReName", "LibraryImage", new { HostName = ViewBag.HostName })';
        $(function () {
            $("#file_upload").uploadify({
                height: 30,
                swf: '@Url.Content("~/Scripts/uploadify/uploadify.swf")',
                uploader: uploadUrl,
                width: 64,
                fileTypeExts: '*.jpg;*.jpge;*.gif;*.png;*.bmp',
                onUploadSuccess: function (file, data, response) {
                    eval(data);
                }
            });
            $("#file_upload-button").after('<div id="div_message" style="position: absolute;top: 0px;left: 100px;width:260px">格式限制：jpg, jpge, gif, png, bmp</div>');
            $("a[name='btnReName']").click(function () {
                var tr = $(this).parent().parent();
                tr.find(".spanFileName").hide();
                tr.find(".txtFileName").show().focus();
                return false;
            });
            $(".txtFileName").blur(function () {
                var value = $(this).val().trim();
                var rvalue = $(this).attr("rawValue").trim();
                if (value.length <= 0) {
                    JAlert({
                        Message: "素材名必须为1到50个字符",
                        DialogType: "Ok",
                        BtnOk: "确定"
                    });
                    return;
                }
                var id = $(this).attr("rawID");
                var regex = /^((?!<!).)*/g;
                var tempValue = value.match(regex)[0];
                if (tempValue.length != value.length) {
                    JAlert({
                        Message: "不能输入非法字符。",
                        DialogType: "Ok",
                        BtnOk: "确定"
                    });
                    return false;
                }
                if (value != rvalue) {
                    $.ajax({
                        type: "post",
                        data: { id: id, name: value },
                        url: renameUrl,
                        success: function (result) {
                            if (result != undefined && result != null && result.length > 0) {
                                eval(result);
                            }
                        },
                        error: function (XMLHttpRequest, textStatus, errorThrown) {
                            JAlert({
                                Message: "格式限制：jpg, jpge, gif, png, bmp.",
                                DialogType: "Ok",
                                BtnOk: "确定"
                            });
                        }
                    });
                }
                console.log($(this).parent().parent().find("a[name='btnReName']").length);
                var tr = $(this).parent().parent();
                tr.find(".txtFileName").hide();
                tr.find(".spanFileName").show();
            });
        });
    </script>
}
@model PagedList<Poco.LibraryImage>
<div class="title">
    素材管理</div>
<div class="bodyLeft">
    <ul class="ulList" id="ulGroup">
        @foreach (var item in libraryType)
        {
            if (item.ID == (int)Poco.Enum.EnumMessageType.Image)
            { 
            <li class="select"><a href="@Url.Action("Index", item.Token, new { HostName = ViewBag.HostName })">@item.Name&nbsp;(@item.Count)</a>
            </li>
            }
            else
            {  
            <li><a href="@Url.Action("Index", item.Token, new { HostName = ViewBag.HostName })">@item.Name&nbsp;(@item.Count)</a>
            </li>
            }
        }
    </ul>
</div>
<div class="bodyRight">
    <div class="option">
        @if (MVCExpandMethod.CheckHasPermissions(this.ViewContext, "Upload", "LibraryImage"))
        { 
            <input id="file_upload" name="file_upload" type="file" multiple="false" />
        }
    </div>
    <table class="tableList" cellpadding="0" cellspacing="0">
        <tr>
            <th style="width: 200px;">
                图片
            </th>
            <th style="width: 350px;">
                文件名
            </th>
            <th>
                操作
            </th>
        </tr>
        @if (Model != null)
        {
            foreach (var item in Model)
            {
            <tr>
                <td>
                    <img src="@Url.Content(item.FilePath)" style="width:80px" />
                </td>
                <td>
                    <span class="spanFileName" style="display: block">@item.FileName</span>
                    <input class="txtFileName" type="text" rawID="@item.ID" rawValue="@item.FileName" value="@item.FileName" style="display:none" />
                </td>
                <td class="operation">
                    @Html.ActionLink("重命名", "ReName", "LibraryImage", new { HostName = ViewBag.HostName, id = item.ID }, new { name = "btnReName" }, true)
                    @Ajax.ActionLink("删除", "Delete", "LibraryImage", new { HostName = ViewBag.HostName, id = item.ID },
                        new AjaxOptions() { UpdateTargetId = "alert", OnBegin = "return AppDelete('确定删除?','" + Url.Action("Delete", "LibraryImage", new { HostName = ViewBag.HostName, id = item.ID }) + "',null)" }, true)
                </td>
            </tr>
            }
        }
    </table>
    <div class="pages">
        @Html.Pager(Model, new PagerOptions
   {
       PageIndexParameterName = "ID",
       CurrentPagerItemWrapperFormatString = "<span class=\"pagenum_selected\"><a>{0}</a></span>",
       NumericPagerItemWrapperFormatString = "<span class=\"pagenum\">{0}</span>",
       NavigationPagerItemWrapperFormatString = "<span class=\"pagenum\">{0}</span>",
       CssClass = "manage_pages pages",
       SeparatorHtml = "&nbsp;",
       AutoHide = false,
       /*LastPageText = "Last",
       FirstPageText = "First",
       PrevPageText = "Back",
       NextPageText = "Next",*/
       PageIndexOutOfRangeErrorMessage = "Page index out of range.",
       ShowFirstLast = false
   })
    </div>
</div>
<div style="clear: both">
</div>
