﻿@{
    Layout = null;
    Poco.Lottery_dish_detail detail = ViewBag.Winning;
    int index = ViewBag.WinningIndex;
}
@model Poco.Lottery_dish
<html>
<head>
    <title>@Model.Name</title>
    <script src="@Url.Content("~/Scripts/jquery-1.8.3.min.js")" type="text/javascript"></script>
    <script type="text/javascript">

        var cans = null;
        var deg = Math.PI / 180;
        var colorArr = [@Html.Raw(ViewBag.Color)];
        var textArr = [@Html.Raw(ViewBag.Name)];        
        var imgArr = [@Html.Raw(ViewBag.Img)];
        var arg = 0;
        var step =50+ 50 * Math.random();
        var t = null;
        var jiaodu = 360 * 1.00 / textArr.length;
        //var finalAngle=360+30;
        $(function () {
           $("#div_canvas").append('<canvas id="can" width="290" height="290"></canvas>');
            var canid = document.getElementById("can");
            cans = canid.getContext("2d");
            cans.translate(145, 145); //cans.strokeStyle="#000000";

            zpFun();
            $("#btnTryAgain").click(function () {
                var arg = 0;
                step = 50 + 50 * Math.random();
                $("#div_canvas").empty().append('<canvas id="can" width="260" height="260"></canvas>');
                var canid = document.getElementById("can");
                cans = canid.getContext("2d");
                cans.translate(130, 130); //cans.strokeStyle="#000000";
                zpFun();
            });
        });
        var isStop=false;
        var sIndex=0;
        function zpFun() {
            var t = setInterval(function () {
                if(isStop==true){
                    if(sIndex>=1){
                    sIndex=0;
                    var msg='';
                   if('@detail.IsWinning'=='True'){
                       msg="恭喜您，您抽中了@(detail.Name)，活动举办方稍后会与您联系。";
                   }else{
                       msg="抱歉，您没有抽中奖品，感谢您的参与。";
                   }
                   $("#div_Msg").text(msg).show();
                    clearInterval(t); 
                    return;
                    }else{
                    sIndex++;
                    }
                }
               if(step>3){
                    step *= 0.95;
               }
                if (step <= 3) {
                    var snum = Math.ceil(arg / jiaodu);
                    var con = textArr[textArr.length - snum];
                    if(con=='@detail.Name'){
                        isStop=true;
                        
//                        cans.font = "20px Arial";
//                        cans.fillStyle = "#cc0000";
//                        cans.textAlign = "center";
//                        cans.fillText(con, 0, 0);
                        //$("#labMsg").text(con);
                       // return;
                    }else{
                     if (arg >= 360) {
                        arg = 0;
                        }
                    }
                    //cans.beginPath();
                    //cans.font="14px 微软雅黑";
                    //cans.textAlign="center";
                    //cans.fillText(textArr[textArr.length-snum],0,0);
                } else {
                    if (arg >= 360) {
                        arg = 0;
                    }
                }
                arg = arg + step;
                cans.clearRect(-500, -500, 1300, 1300);
                
                //画扇形
                cans.save();
                cans.rotate(arg * deg);
                cans.lineWidth = 1;
                
                for (var i = 0; i < textArr.length; i++) {
                     cans.beginPath();
                     cans.fillStyle = colorArr[i];
                     cans.moveTo(0, 0);
                     cans.arc(0, 0, 140, i * jiaodu * deg, (i + 1) * jiaodu * deg);
                     cans.closePath();
                     cans.fill();
                     cans.stroke();
                }
                
                //画中心园
                cans.beginPath();
                cans.fillStyle = "#ffffff";
                //cans.arc(0, 0, 50, 0, 360 * deg);
                cans.fill();
                cans.rotate(-arg * deg);
                var bg=new Image();
                bg.src="/Images/pointer.png"
                cans.drawImage(bg,-35,-35,103,70);
                cans.rotate(arg * deg);
                

                //写文字
                var t_j=180/colorArr.length;
                var i_j=t_j-18;
                for (var i = 0; i <colorArr.length; i++) {               
                   cans.save();
                   cans.beginPath();
                   cans.rotate((i * jiaodu + t_j) * deg);
                   cans.font = "16px @@Arial";
                   cans.fillText(textArr[i], 40,0);
                   cans.restore();              
                   
                   var imgPath=imgArr[i];
                   if(imgPath.length>0){
                       var img=new Image();
                       img.src = imgPath;
                       cans.save();
                       cans.beginPath(); 
                       cans.rotate((i * jiaodu +i_j) * deg);
                       cans.arc(110, 30, 30, 0, Math.PI * 2, true);
                       cans.closePath();
                       cans.clip();
                       cans.drawImage(img,80, 0, 60, 60);
                       cans.restore();
                    }
                }
                cans.restore();
            }, 60);
        }
    </script>
</head>
<body style="margin: 0px">
    <div style="font-size: 17px; text-align: center; padding-top: 10px">@Model.Name</div>
    <br />
    <div id="div_canvas">
    </div>
    <br />
    <div id="div_Msg" style="text-align: center; font-size: 15px; display: none">
    </div>
</body>
</html>
